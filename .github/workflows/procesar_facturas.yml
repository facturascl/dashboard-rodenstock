name: Procesar Facturas Autom√°tico

# ============================================
# TRIGGERS - Cu√°ndo se ejecuta
# ============================================
on:
  # Ejecuci√≥n manual (para pruebas)
  workflow_dispatch:
    inputs:
      debug:
        description: 'Activar modo debug'
        required: false
        default: 'false'
  
  # Ejecuci√≥n autom√°tica diaria a las 20:00 hrs Chile (23:00 UTC)
  # Chile est√° en UTC-3 (verano) o UTC-4 (invierno)
  # Para 20:00 Chile ‚Üí 23:00 UTC (horario de verano)
  schedule:
    - cron: '0 23 * * *'  # 20:00 Chile (UTC-3 verano)

# ============================================
# PERMISOS
# ============================================
permissions:
  contents: write  # Necesario para hacer commit y push

# ============================================
# JOBS
# ============================================
jobs:
  procesar-facturas:
    runs-on: ubuntu-latest
    
    steps:
      # ============================================
      # 1. CHECKOUT - Descargar c√≥digo del repo
      # ============================================
      - name: üì• Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Descargar historial completo
      
      # ============================================
      # 2. SETUP PYTHON - Instalar Python 3.11
      # ============================================
      - name: üêç Setup Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'  # Cachear dependencias
      
      # ============================================
      # 3. INSTALAR DEPENDENCIAS
      # ============================================
      - name: üì¶ Instalar dependencias
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
      
      # ============================================
      # 4. CONFIGURAR CREDENCIALES (desde Secrets)
      # ============================================
      - name: üîê Configurar credenciales Gmail
        env:
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
          GMAIL_CONFIG: ${{ secrets.GMAIL_CONFIG }}
        run: |
          echo "üîß Configurando credenciales desde secrets..."
          # Las credenciales se configuran autom√°ticamente
          # via variables de entorno que Rodenstock.py detecta
      
      # ============================================
      # 5. EJECUTAR PROCESAMIENTO
      # ============================================
      - name: üöÄ Ejecutar Rodenstock.py
        id: procesar
        env:
          GMAIL_TOKEN: ${{ secrets.GMAIL_TOKEN }}
          GMAIL_CONFIG: ${{ secrets.GMAIL_CONFIG }}
          GITHUB_ACTIONS: true
          DEBUG: ${{ github.event.inputs.debug }}
        run: |
          echo "================================"
          echo "üöÄ Iniciando procesamiento..."
          echo "üìÖ Fecha: $(date)"
          echo "================================"
          python scripts/Rodenstock.py
          
          # Guardar c√≥digo de salida
          echo "exit_code=$?" >> $GITHUB_OUTPUT
      
      # ============================================
      # 6. COMMIT Y PUSH DE CAMBIOS
      # ============================================
      - name: üíæ Commit y push de cambios
        id: commit
        run: |
          echo "üîç Verificando cambios..."
          
          # Configurar git
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
          
          # Agregar archivos que se actualizan
          git add data/facturas.db
          git add outputs/
          git add last_processed.txt
          git add processed_messages.json
          
          # Ver qu√© cambi√≥
          git status
          
          # Commit solo si hay cambios
          if git diff --staged --quiet; then
            echo "‚ÑπÔ∏è  No hay cambios para commitear"
            echo "cambios=false" >> $GITHUB_OUTPUT
          else
            echo "‚úÖ Cambios detectados, comiteando..."
            git commit -m "auto: Facturas procesadas - $(date +'%Y-%m-%d %H:%M') UTC"
            git push
            echo "‚úÖ Cambios subidos a GitHub"
            echo "cambios=true" >> $GITHUB_OUTPUT
          fi
      
      # ============================================
      # 7. ENVIAR NOTIFICACI√ìN POR EMAIL (√âXITO)
      # ============================================
      - name: ‚úÖ Enviar email de √©xito
        if: success()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ‚úÖ Facturas procesadas exitosamente - ${{ github.run_number }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_EMAIL }}>
          body: |
            ‚úÖ El procesamiento de facturas se complet√≥ exitosamente
            
            üìä Detalles de ejecuci√≥n:
            ‚Ä¢ Fecha: ${{ github.event.repository.updated_at }}
            ‚Ä¢ Workflow: ${{ github.workflow }}
            ‚Ä¢ Ejecutado por: ${{ github.actor }}
            ‚Ä¢ Tipo: ${{ github.event_name == 'schedule' && 'Autom√°tico (20:00 hrs)' || 'Manual' }}
            ‚Ä¢ Cambios detectados: ${{ steps.commit.outputs.cambios }}
            
            üîó Ver detalles completos:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            Este es un mensaje autom√°tico de GitHub Actions
      
      # ============================================
      # 8. ENVIAR NOTIFICACI√ìN POR EMAIL (ERROR)
      # ============================================
      - name: ‚ùå Enviar email de error
        if: failure()
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          username: ${{ secrets.SMTP_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: ‚ùå ERROR al procesar facturas - ${{ github.run_number }}
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: GitHub Actions <${{ secrets.SMTP_EMAIL }}>
          body: |
            ‚ùå El procesamiento de facturas FALL√ì
            
            üìä Detalles del error:
            ‚Ä¢ Fecha: ${{ github.event.repository.updated_at }}
            ‚Ä¢ Workflow: ${{ github.workflow }}
            ‚Ä¢ Ejecutado por: ${{ github.actor }}
            ‚Ä¢ Tipo: ${{ github.event_name == 'schedule' && 'Autom√°tico (20:00 hrs)' || 'Manual' }}
            
            üîç Acci√≥n requerida:
            Revisa los logs para identificar el problema
            
            üîó Ver logs completos:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            Este es un mensaje autom√°tico de GitHub Actions
      
      # ============================================
      # 9. RESUMEN (solo si hay falla)
      # ============================================
      - name: üìä Resumen de ejecuci√≥n
        if: failure()
        run: |
          echo "‚ùå El procesamiento fall√≥"
          echo "üìã Revisa los logs arriba para ver el error"
          echo "üìß Se envi√≥ notificaci√≥n por email"
          exit 1

# ============================================
# NOTAS:
# - El workflow se ejecuta a las 20:00 Chile
# - Usa secrets: GMAIL_TOKEN, GMAIL_CONFIG, SMTP_EMAIL, SMTP_PASSWORD, NOTIFICATION_EMAIL
# - Env√≠a notificaciones por email en caso de √©xito o error
# - Commitea cambios autom√°ticamente
# - Puedes ejecutarlo manualmente en GitHub Actions
# ============================================